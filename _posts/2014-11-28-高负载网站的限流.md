---
layout: post
title:  "高负载网站的限流——令牌桶算法应用"
keyword: "高负载网站的限流,令牌筒算法应用,运维,算法,高负载"
date:   2014-11-28
categories: 运维
tags:	运维 算法 高负载
---

前段时间，我司的网站经历了双十一的洗礼。在这个电商盛会中，网站受到了数十倍的流量与业务量的冲击。接下来分享在双十一前一天完成的令牌筒限流的细节——结果还是好的，双十一期间没有当机停止服务，也算是一个胜利。

## 技术背景 ##
令牌桶算法是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法。典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。

![令牌桶演示图](http://shenhd-blog.oss-cn-hangzhou.aliyuncs.com/img/lingpaitong_01.png "令牌桶演示图")

如图，令牌桶算法通过桶来保存令牌。生产者以一定的速率往桶中存令牌；消费者要消费这个资源，就需要先取桶中的令牌，如果取到就放行（操作成功），如果没有取到令牌，操作失败（直接错误或者延迟操作）。

## 实现 ##
因我司使用PHP来做网站，所以使用PHP示例：

### 令牌存储 ###
{% highlight php %}
<?php
// bucket_put.php
$memcache = new Memcache;
$memcache->connect('127.0.0.1', 11211);
while(TRUE) {
        $memcache->set('bucket.count', 10, 0, 60);
        usleep(1e6);
        echo 'set bucket count = 10' . "\n";
}
{% endhighlight %}

### 令牌读取 ###
{% highlight php %}
<?php
// bucket_get.php
$memcache = new Memcache;
$memcache->connect('127.0.0.1', 11211);
$bucket_count = $memcache->get('bucket.count');
if ($bucket_count <= 0) {
        echo "Request Failed";
} else {
        $memcache->decrement('bucket.count');
}
{% endhighlight %}

### 测试 ###
在开启了bucket_put.php脚本存令牌时:

{% highlight bash %}
% php bucket_put.php
{% endhighlight %}

使用下面这个简单的脚本测试了令牌读取功能

{% highlight php %}
<?php
// bucket_test.php
$memcache = new Memcache;
$memcache->connect('127.0.0.1', 11211);
$statistics = array('succeed' => 0, 'failed' => 0);

for($i=0; $i<=1000; $i++) {
        $bucket_count = $memcache->get('bucket.count');
        if ($bucket_count <= 0) {
                $statistics['failed'] ++;
        } else {
                $memcache->decrement('bucket.count');
                $statistics['succeed'] ++;
        }
        usleep(rand(1e4, 2e5));
}
echo "成功: " . $statistics['succeed'] . " 失败: " . $statistics['failed'] . "\n";
{% endhighlight %}


### 测试结果 ###
{% highlight bash %}
% php bucket_test.php
成功: 948 失败: 53
{% endhighlight %}

## 后记 ##
此次使用的算法实现效果更像漏筒算法，因为在存储时不是以一定速率加令牌，而是直接设置成了指定的数目，是为了做存取操作的简便性考虑。
在本次实验中，测试的手段比较简陋，但是大概表达了意图。高负载是一门学问，本人还有很多要学的地方。仅以此文抛砖引玉。

