---
layout: post
title:  "NAS自搭建与配置"
subtitle: ""
keyword: "nas,docker,j4105,htpc,ddr4"
date:   2018-05-01
categories: nas
tags:	nas htpc
background: '/img/posts/06.jpg'
---
# 为什么写这篇博客

炫技！初衷也没有想做一个大而全的攻略，只想分享个人历程，给其他同学提供一个借鉴思路。

### 为什么要搭NAS

自搭NAS的好处懂的同学自然懂，简单来说就是：共享、便捷、安全。

- 备份：平时可以同步备份一些照片、小视频:>、大电影、下载等乱七八糟的东西，对程序猿来说，存一些零碎的配置文件，出门不会丢三落四，不要太爽

- 兼职HTPC：配合一些性能稍好的CPU直接硬解4k，取代专用的HTPC，节省成本

- 兼职服务器：搭一些奇奇怪怪的服务，常见的如gitlab、Nexus、Leanote等，还有小众的服务如Wekan，能用开源方式实现一大堆功能，数据存在自己的服务器上更放心

- 虚拟机服务器：NAS的CPU大多支持虚拟化，能跑一些玩的系统

### 和普通PC比优势在哪里？

重要的事情说三遍：省电！省电！省电！

实现上述的功能，却只需要20W ~ 30W的电量，一年放着也用不了多少电费（精打细算脸）。

### 为什么不用白群晖？

太贵。。。

# 硬件筹备

只打算讲重要的两个：CPU和机箱（毕竟也不拿广告费，哈哈）。

### CPU（主板）

一段时间史：

- 手头有一台老的NAS机器，CPU是D525（Atom），性能比较差，[CPU Benchmarks](https://www.cpubenchmark.net/cpu.php?cpu=Intel+Atom+D525+%40+1.80GHz&id=611)，开机比较慢，跑起docker也比较费劲。当HTPC就不要想了。

- 当前比较流行的CPU主要是J3455，[CPU Benchmarks](https://www.cpubenchmark.net/cpu.php?cpu=Intel+Celeron+J3455+%40+1.50GHz&id=2875)

- 2017年底牙膏厂发布了J4105（可以直接忽略J4205了）,[CPU Benchmark](https://www.cpubenchmark.net/cpu.php?cpu=Intel+Celeron+J4105+%40+1.50GHz&id=3159)

J4105优点：

- 原生4k@60hz：与上一代J4205一样，支持到4k@60hz，但是据说hdmi为原生，支持bt.2020，HDR10（没有仔细考究）。

- 支持DDR4：毕竟NAS是个相对低性能的平台，提升内存性能也会有比较高的性价比

总体来看，J4105在维持低功耗的同时，也能提供相对较好的性能，做HTPC靠谱一点。而且按照电子产品买新不买旧原则，我选择了J4105。

至于主板，截止目前（5月1日）还只听说过华擎出了相应产品（J4105-ITX，翻白眼），这款主板目前来看比较明显的缺点：

- 仅支持8G内存（4x2），未测试

- 板载只有4个SATA口（通过PCI-E x1加扩展卡还能扩展出若干，但是受限于x1的带宽，肯定是存在瓶颈的）

- 仅支持UEFI，对linux系统安装会有一些阻碍

### 机箱

选择要点是：

- 静音：不管做什么，静音总是最重要的

- 硬盘位多：别忘记本职

- 颜值高：毕竟要兼职HTPC

- 尽可能小：只能排最后了

真是组NAS的核心难题。。。

各种机箱之间也差异较大。主要分为以下几类：

- 品牌NAS机箱：专用的热插拔硬盘架，颜值也比较在线，但是性价比不一般的低。没错，说的就是你，万向。PASS

- 定制的工控机箱：价格优势明显，盘位一般也比较多，但是噪音、颜值、体积全下线。PASS

- HTPC机箱：寻找折中方案，在颜值比较高的HTPC里去寻找盘位尽可能多的产品。

最后，是在HTPC机箱里找到了一个款比较合适的。。。

### 组装

<img src="/assets/images/20180502234353.jpg" style="max-width:40em" alt="主板" title="主板">

# 网络

网络这块单独拿出来，甚至放在操作系统的前面，是因为后面NAS很多功能都依赖于外部访问，如备份、服务提供。而且通常来说，一个家庭的网络环境通常无法变更，却对后续NAS功能有巨大的影响

下面主要针对如何具体情况给出方案。

## 家庭网络常见类型

- 有公网IP：如ADSL/FTTH(光纤到户)，特点是主路由器上的WAN IP是一个外网地址，可以在外网直接访问到

- 无公网IP：如FTTB(光纤到楼)，特点是主路由器上的WAN IP是一个内网地址，因为NAT，外网无法直接访问

## 有公网IP

这种情况一般出现在老小区，路由器PPPoE拨号时分配到一个随机的公网IP，这个IP能在任何地方访问。

我们只需要把NAS机器上的服务端口映射到路由器上，那么服务就连接到了公网。

该方式提供的网络速度=网络上行速度（具体要见各地运营商的策略）

唯一需要解决的问题是如果寻找到这个动态的公网IP地址。可选的方案绑定域名并且使用dnspod定期更新域名。

注：很多运营商禁止访问80/443端口

## 无公网IP

在新式小区一般才会采用这种方式（运营商成本较低）

这时，一般都需要寻找一台公网服务器，通过端口映射的方式，把本地服务接入外网，常见方案有花生壳（收费服务）、私有服务器+ssh/frp端口映射。

无论如何，都需要额外的成本，并且注意网络攻击与远程服务器的数据安全。

# 操作系统

目前能想到的主流选择是黑群晖、OMV(openmediavault)。

总结一下个人的需求，转化为技术指标的话有以下几点必需要考虑：

- 可靠的数据同步备份方案

- 管理面板远程访问、服务端口映射到外网的实现方案

- 远程下载，能支持普通、BT、电驴等下载

- docker、vm必须支持

群晖是集成方案，除了虚拟机无法实现，其他基本都有了比较完善的方案。但是因为黑群晖没有官方服务与技术支持，遇到了一些问题（如突然无法打开docker终端）。白群晖远程访问功能也没有，总体来说优势不大，所以放弃群晖。

OMV优点：

- 基于debian，对于玩惯了Linux系统的人来说，基本没有实现不了的东西。

- OMV的整体配置比较底层，能更好的控制系统/组件的运行

OMV缺点：

- 每个linux实现不了的功能都需要琢磨一套可行的开源方案

总之，OMV更符合我的预期。所以后面NAS会基于OMV。至于群晖，里面有太多兼容性问题，后面就不再讨论了。

## OMV3安装过程

### 启动盘准备

### 系统安装

安装U盘

### 基本配置
